#
# Makefile for the RAT project. This requires GNU make on many systems.
#

CFLAGS  = @WFLAGS@ @DEBUG@ @CHAR@ @PROFILE@ @OPTIMIZE@ @CHECK_FLAG@ @DEFS@ -D@OSTYPE@ -DSASR -DFAST -DUSE_FLOAT_MUL
INCLUDE = @INCLUDE@
CC      = @CC@
AR      = @AR@
RANLIB  = @RANLIB@
RATVER  = rat-@VERSION@

AUDIO_OBJS   = @AUDIO@ auddev.o auddev_null.o audio_fmt.o audio_util.o auddev_trans.o
CODEC_OBJS   = codec.o codec_state.o codec_dvi.o codec_gsm.o \
               codec_l16.o codec_g711.o codec_g726.o codec_lpc.o \
               codec_types.o codec_vdvi.o codec_wbs.o cx_dvi.o \
               cx_g726.o cx_g726_16.o cx_g726_24.o cx_g726_32.o cx_g726_40.o \
               cx_gsm.o cx_lpc.o cx_vdvi.o cx_wbs.o \
               converter.o convert_util.o convert_extra.o convert_linear.o \
               convert_sinc.o bitstream.o

SNDFILE_OBJS = sndfile.o sndfile_au.o sndfile_raw.o sndfile_wav.o
MEDIALIBS    = libuclaudio.a libuclcodec.a libuclsndfile.a 

CHANNEL_OBJS = channel.o channel_types.o cc_vanilla.o cc_rdncy.o cc_layered.o
TOY_OBJS     = render_3D.o repair.o 
CORE_OBJS    = ts.o playout.o net.o source.o session.o \
               mbus_engine.o audio.o cushion.o mix.o \
               parameters.o timers.o transmit.o playout_calc.o \
               transcoder.o ui.o rtp_callback.o usleep.o settings.o \
               pdb.o pktbuf.o

UI_OBJS      = tcltk.o mbus_ui.o main_ui.o
CTRL_OBJS    = main_control.o mbus_control.o
TCL_OBJS     = ui_audiotool.o ui_transcoder.o
TCL_SRCS     = $(TCL_OBJS:%.o=%.c)

ALL_OBJS     = $(AUDIO_OBJS) $(CODEC_OBJS) $(SNDFILE_OBJS) $(CHANNEL_OBJS) $(TOY_OBJS)\
	       $(CORE_OBJS) $(UI_OBJS) $(CTRL_OBJS)
ALL_SRCS     = $(ALL_OBJS:%.o=%.c)

all: version.h sdr2.plugin.s02.audio.rtp.-.rat-@VERSION@ rat-@VERSION@.spec $(RATVER) $(RATVER)-ui $(RATVER)-media 

libuclaudio.a: $(AUDIO_OBJS)
	$(AR) r $@ $(AUDIO_OBJS)
	$(RANLIB) $@

libuclcodec.a: $(CODEC_OBJS)
	$(AR) r $@ $(CODEC_OBJS)
	$(RANLIB) $@

libuclsndfile.a: $(SNDFILE_OBJS)
	$(AR) r $@ $(SNDFILE_OBJS)
	$(RANLIB) $@

$(RATVER)-media: $(CHANNEL_OBJS) $(TOY_OBJS) $(CORE_OBJS) $(MEDIALIBS) main_engine.o ../common/libcommon.a
	$(CC) $(CFLAGS) $(CHANNEL_OBJS) $(TOY_OBJS) $(CORE_OBJS) $(MEDIALIBS) main_engine.o ../common/libcommon.a @LDLIBS@ @CHECK_LIB@ -o $(RATVER)-media

$(RATVER)-ui: $(TCL_OBJS) $(UI_OBJS) ../common/libcommon.a
	$(CC) $(CFLAGS) $(TCL_OBJS) $(UI_OBJS) ../common/libcommon.a @LDLIBS@ @CHECK_LIB@ -o $(RATVER)-ui 

$(RATVER): $(CTRL_OBJS) ../common/libcommon.a
	$(CC) $(CFLAGS) $(CTRL_OBJS) ../common/libcommon.a @LDLIBS@ @CHECK_LIB@ -o $(RATVER)

.c.o:
	$(CC) $(INCLUDE) $(CFLAGS) -c $<

$(TCL_OBJS): $(TCL_SRCS)

ui_transcoder.c: ui_transcoder.tcl tcl2c/tcl2c
	cat ui_transcoder.tcl | tcl2c/tcl2c ui_transcoder > ui_transcoder.c

ui_audiotool.c: ui_audiotool.tcl tcl2c/tcl2c
	cat asfilebox.tcl ui_audiotool.tcl | tcl2c/tcl2c ui_audiotool > ui_audiotool.c

tcl2c/tcl2c: tcl2c/tcl2c.c
	$(CC) -o tcl2c/tcl2c tcl2c/tcl2c.c

version.h: VERSION
	 sed -e 's/.*/#define RAT_VERSION "v& @OSTYPE@"/' VERSION > version.h
	 sed -e 's/.*/#define VERSION_NUM "v&"/' VERSION >> version.h

sdr2.plugin.s02.audio.rtp.-.rat-@VERSION@: sdr2.plugin.in
	${ECHO} "# Generated automatically from sdr2.plugin.in" > $@
	${ECHO} "# DO NOT EDIT THIS FILE" >> $@
	sed -e 's/VERSION/@VERSION@/g' sdr2.plugin.in >> $@

rat-@VERSION@.spec: rat.spec
	${ECHO} "Generating RPM spec file"
	${ECHO} "# Generated automatically from rat.spec"  > $@
	${ECHO} "# DO NOT EDIT THIS FILE"                 >> $@
	cat rat.spec | sed s/VERSION/@VERSION@/g       >> $@

clean:
	-rm -f $(CTRL_OBJS) $(AUDIO_OBJS) $(CODEC_OBJS) $(SNDFILE_OBJS) $(CHANNEL_OBJS) $(TOY_OBJS) $(CORE_OBJS) $(UI_OBJS) $(TCL_OBJS) main_engine.o 
	-rm -f $(MEDIALIBS)
	-rm -f tcl_libs.c ui_audiotool.c ui_transcoder.c version.h Makefile Makefile.sed 
	-rm -f tcl2c/tcl2c sdr2.plugin.S02.audio.rtp.-.$(RATVER) $(RATVER).spec
	-rm -f $(RATVER)-media $(RATVER)-ui $(RATVER)

etags:
	etags ../common/*.[ch] *.[ch]

ctags:
	ctags ../common/*.[ch] *.[ch] 

release:
	cvs tag release-`cat VERSION | sed "s/\./-/g"`

tgz: $(RATVER)
	tar cvf $(RATVER)-@OSTYPE@.tar README.* MODS COPYRIGHT INSTALL.TXT VERSION $(RATVER) $(RATVER)-ui $(RATVER)-media
	gzip -9v $(RATVER)-@OSTYPE@.tar

depend:
	makedepend $(INCLUDE) $(ALL_SRCS)
# DO NOT DELETE THIS LINE
