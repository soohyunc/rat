#!/bin/sh
#
# Configure script for rat. This script determines the type of machine it's
# running on, and builds a Makefile with the appropriate macro definitions
# to set up the machine specific includes etc.
#
# Copyright (c) 1998 University College London
# All rights reserved.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
# 1. Redistributions of source code must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
# 2. Redistributions in binary form must reproduce the above copyright
#    notice, this list of conditions and the following disclaimer in the
#    documentation and/or other materials provided with the distribution.
# 3. All advertising materials mentioning features or use of this software
#    must display the following acknowledgement:
#      This product includes software developed by the Computer Science
#      Department at University College London
# 4. Neither the name of the University nor of the Department may be used
#    to endorse or promote products derived from this software without
#    specific prior written permission.
#
# THIS SOFTWARE IS PROVIDED BY THE AUTHORS AND CONTRIBUTORS ``AS IS'' AND
# ANY EXPRESSED OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
# ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHORS OR CONTRIBUTORS BE LIABLE
# FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
# DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
# OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
# HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
# LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
# OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
# SUCH DAMAGE.
#

VERSION=`cat VERSION`

OSTYPE=`uname -s`
case $OSTYPE in
  SunOS                  ) OSTYPE=`uname -s`_`uname -r | awk -F. '{print $1}'`
  			   if [ $OSTYPE = SunOS_4 ]; then
			   	OSTYPE=SunOS
			   elif [ $OSTYPE = SunOS_5 ]; then
			   	OSTYPE=Solaris
			   fi
                           ;;
  HP-UX                  ) OSTYPE=HPUX
                           ;;
  Linux | IRIX | FreeBSD ) 
                           ;;
  *                      ) echo "$OSTYPE"
                           echo "Not supported."
                           exit
                           ;;
esac

echo "Configuring RAT v$VERSION for $OSTYPE"

GCCWFLAGS="-W -Wall -Wbad-function-cast -Wmissing-prototypes -Wno-implicit"
TCL_LIBS="../tk-8.0/unix/libtk8.0.a ../tcl-8.0/unix/libtcl8.0.a"
TCL_INCL="-I../tk-8.0/generic -I../tcl-8.0/generic"

case $OSTYPE in
  SunOS   ) CC="gcc"
            WFLAGS=$GCCWFLAGS
	    INCLUDE="-I/usr/ucl/X11/include -I/usr/demo/SOUND"
	    LDLIBS="-lXext -lX11 -L/usr/demo/SOUND -laudio -lm"
	    AUDIO="auddev_sparc.o"
	    DEBUG="-g"
	    CHAR="-fsigned-char"
	    OPTIMIZE="-O4"
	    PROFILE="-pg"
            ;;
  Solaris ) CC="/opt/ucl/bin/gcc -pipe"
            WFLAGS=$GCCWFLAGS
	    INCLUDE="-I/usr/demo/SOUND/include -I/usr/openwin/include"
	    LDLIBS="-L/usr/openwin/lib -lXext -lX11 -L/usr/demo/SOUND/lib -laudio -lsocket -ldl -lnsl -lm"
	    AUDIO="auddev_sparc.o"
	    DEBUG="-g"
	    CHAR="-fsigned-char"
	    OPTIMIZE="-O4"
	    PROFILE="-pg"
            ;;
  IRIX    ) CC="cc"
            WFLAGS="-fullwarn"
	    INCLUDE="-I/usr/ucl/X11/include"
	    LDLIBS="-L/usr/lib/X11 -lX11 -laudio -lm"
	    AUDIO="auddev_sgi.o"
	    DEBUG="-g"
	    CHAR="-signed"
	    OPTIMIZE="-O2"
	    PROFILE=""
            ;;
  Linux   ) CC="gcc"
            WFLAGS=$GCCWFLAGS
	    INCLUDE="-I/usr/X11R6/include"
	    LDLIBS="-L/usr/X11R6/lib -lX11 -lm -ldl"
	    AUDIO="auddev_oss.o"
	    DEBUG="-g"
	    CHAR="-fsigned-char"
	    OPTIMIZE="-O4"
	    PROFILE="-pg"
            ;;
  FreeBSD ) CC="gcc"
            WFLAGS=$GCCWFLAGS
	    INCLUDE="-I/usr/X11R6/include -I/usr/local/include"
	    LDLIBS="-L/usr/X11R6/lib -lXext -lX11 -lm"
	    AUDIO="auddev_luigi.o"
	    DEBUG="-g"
	    CHAR="-fsigned-char"
	    OPTIMIZE="-O4"
	    PROFILE="-pg"
            ;;
  HPUX    ) CC="gcc"
            WFLAGS=$GCCWFLAGS
	    INCLUDE="-I/usr/include/X11"
	    LDLIBS="-L/usr/lib/X11R5 -lXext -lX11 -lAlib -lm -ldld"
	    AUDIO="auddev_hpux_raw.o"
	    DEBUG="-g"
	    CHAR="-fsigned-char"
	    OPTIMIZE="-O4"
	    PROFILE="-pg"
            ;;
esac

# Process options to the configure script...
DEBUG2=""
OPTIMIZE2=""
PROFILE2=""
DEFS=""
CHECK_FLAG=""
CHECK_LIB=""
while test $# -gt 0
do
	if [ $1 = "-debug" ]; then
		DEBUG2=$DEBUG
		DEFS="-DDEBUG"
		echo "Enabled debug option"
	elif [ $1 = "-optimize" ]; then
		OPTIMIZE2=$OPTIMIZE
		DEFS="-DNDEBUG"
		echo "Enabled optimize option"
	elif [ $1 = "-profile" ]; then
		PROFILE2=$PROFILE
		echo "Enabled profile option"
	elif [ $1 = "-bounds" ]; then
		CHECK_FLAG=-fbounds-checking
		CHECK_LIB=-lcheck
		echo "Enabled bounds checking option"
	else 
		DEFS="$DEFS $1"
		echo "Added $1 compile flag"
	fi
	shift
done

# Create Makefile
echo "Generating Makefile"
echo "# Generated automatically from Makefile.in" > Makefile
echo "# DO NOT EDIT THIS FILE" >> Makefile
cat Makefile.in \
| sed "s@__OSTYPE__@$OSTYPE@" \
| sed "s@__CC__@$CC@" \
| sed "s@__WFLAGS__@$WFLAGS@" \
| sed "s@__INCLUDE__@$INCLUDE $TCL_INCL@" \
| sed "s@__LDLIBS__@$LDLIBS $TCL_LIBS@" \
| sed "s@__AUDIO__@$AUDIO@" \
| sed "s@__CHAR__@$CHAR@" \
| sed "s@__DEBUG__@$DEBUG2@" \
| sed "s@__OPTIMIZE__@$OPTIMIZE2@" \
| sed "s@__PROFILE__@$PROFILE2@" \
| sed "s@__DEFS__@$DEFS@" \
| sed "s@__CHECK_FLAG__@$CHECK_FLAG@" \
| sed "s@__CHECK_LIB__@$CHECK_LIB@" \
>> Makefile

# Create version.h
echo "Generating version.h"
echo \#define RAT_VERSION \"RAT v$VERSION $OSTYPE\" > version.h

